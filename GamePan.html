<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ë“œë¯¼í„´ ë³µì‹ ê²Œì„ ë°°ì •íŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .courts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .court-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .column-title {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            padding: 6px;
            background: #f0f0f0;
            border-radius: 6px;
        }

        .court {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            min-height: 100px;
            background: #fafafa;
            position: relative;
            transition: all 0.3s ease;
        }

        .court.game-court {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .court.game-court.lesson-court {
            border-color: #9C27B0;
            background: #f3e5f5;
        }

        .court.waiting-court {
            border-color: #FF9800;
            background: #fff3e0;
        }

        .court.drag-over {
            border-color: #2196F3;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .court-title {
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .court.waiting-court .court-title {
            cursor: move;
            user-select: none;
        }

        .court.waiting-court.dragging {
            opacity: 0.6;
            transform: scale(0.98);
        }

        .court-number {
            font-size: 1em;
        }

        .end-game-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.3s;
        }

        .end-game-btn:hover {
            background: #d32f2f;
        }

        .end-game-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .lesson-btn {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.3s;
            margin-right: 4px;
        }

        .lesson-btn:hover {
            background: #7B1FA2;
        }

        .lesson-btn.active {
            background: #6A1B9A;
            font-weight: bold;
        }

        .court-players {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 60px;
        }

        .player {
            background: white;
            border: 2px solid #2196F3;
            border-radius: 6px;
            padding: 4px 10px;
            cursor: move;
            user-select: none;
            transition: all 0.2s;
            position: relative;
            font-weight: 500;
            color: #333;
            font-size: 0.9em;
        }

        .player.male {
            border-color: #2196F3; /* íŒŒë€ìƒ‰ */
        }

        .player.female {
            border-color: #E91E63; /* í•‘í¬ìƒ‰ */
        }

        .player:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .player.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .player .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .player:hover .delete-btn {
            display: flex;
        }

        .waiting-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .waiting-section {
            background: #f5f5f5;
            border: 2px dashed #999;
            border-radius: 8px;
            padding: 12px;
            min-height: 120px;
        }

        .waiting-section.present-area {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .waiting-section.absent-area {
            border-color: #9e9e9e;
            background: #f5f5f5;
        }

        .waiting-section.drag-over {
            border-color: #2196F3;
            background: #e3f2fd;
        }

        .waiting-area-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        .delete-all-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.3s;
        }

        .delete-all-btn:hover {
            background: #d32f2f;
        }

        .reset-present-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.3s;
        }

        .reset-present-btn:hover {
            background: #F57C00;
        }

        .waiting-players {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .player-management {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
        }

        .player-management-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .add-player-form {
            display: flex;
            gap: 10px;
        }

        .add-player-input {
            flex: 1;
            max-width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .add-player-input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .add-player-select {
            flex: 0 0 156px;
            max-width: 156px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .add-player-select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .add-player-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background 0.3s;
        }

        .add-player-btn:hover {
            background: #45a049;
        }

        .empty-court-message {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 10px;
            font-size: 0.85em;
        }

        .court-warning-message {
            color: #f44336;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            font-size: 0.85em;
            background: #ffebee;
            border-radius: 4px;
            margin-top: 6px;
        }

        @media (max-width: 768px) {
            .courts-section {
                grid-template-columns: 1fr;
            }

            .waiting-area {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¸ ë°°ë“œë¯¼í„´ ë³µì‹ ê²Œì„ ë°°ì •íŒ</h1>

        <div class="courts-section">
            <!-- ê²Œì„ì¤‘ ì½”íŠ¸ -->
            <div class="court-column">
                <div class="column-title">ê²Œì„ì¤‘ ì½”íŠ¸</div>
                <div class="court game-court" data-court-type="game" data-court-index="0" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <div class="court-title">
                        <span class="court-number">ì½”íŠ¸ A</span>
                        <div>
                            <button class="lesson-btn" onclick="toggleLessonCourt(0)">ë ˆìŠ¨ ì½”íŠ¸ ì§€ì •</button>
                            <button class="end-game-btn" onclick="endGame(0, 'game')">ê²Œì„ ì¢…ë£Œ</button>
                        </div>
                    </div>
                    <div class="court-players"></div>
                </div>
                <div class="court game-court" data-court-type="game" data-court-index="1" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <div class="court-title">
                        <span class="court-number">ì½”íŠ¸ B</span>
                        <div>
                            <button class="lesson-btn" onclick="toggleLessonCourt(1)">ë ˆìŠ¨</button>
                            <button class="end-game-btn" onclick="endGame(1, 'game')">ê²Œì„ ì¢…ë£Œ</button>
                        </div>
                    </div>
                    <div class="court-players"></div>
                </div>
                <div class="court game-court" data-court-type="game" data-court-index="2" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <div class="court-title">
                        <span class="court-number">ì½”íŠ¸ C</span>
                        <div>
                            <button class="lesson-btn" onclick="toggleLessonCourt(2)">ë ˆìŠ¨</button>
                            <button class="end-game-btn" onclick="endGame(2, 'game')">ê²Œì„ ì¢…ë£Œ</button>
                        </div>
                    </div>
                    <div class="court-players"></div>
                </div>
                <div class="court game-court" data-court-type="game" data-court-index="3" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <div class="court-title">
                        <span class="court-number">ì½”íŠ¸ D</span>
                        <div>
                            <button class="lesson-btn" onclick="toggleLessonCourt(3)">ë ˆìŠ¨</button>
                            <button class="end-game-btn" onclick="endGame(3, 'game')">ê²Œì„ ì¢…ë£Œ</button>
                        </div>
                    </div>
                    <div class="court-players"></div>
                </div>
            </div>

            <!-- ëŒ€ê¸°ì¤‘ ì½”íŠ¸ -->
            <div class="court-column">
                <div class="column-title">ëŒ€ê¸°ì¤‘ ì½”íŠ¸</div>
                <div class="court waiting-court" data-court-type="waiting" data-court-index="0" draggable="true" ondragstart="handleCourtDragStart(event)" ondragend="handleCourtDragEnd(event)" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <div class="court-title">
                        <span class="court-number">ëŒ€ê¸° ì½”íŠ¸ 1</span>
                        <button class="end-game-btn" onclick="resetCourt(0, 'waiting')">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="court-players"></div>
                </div>
                <div class="court waiting-court" data-court-type="waiting" data-court-index="1" draggable="true" ondragstart="handleCourtDragStart(event)" ondragend="handleCourtDragEnd(event)" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <div class="court-title">
                        <span class="court-number">ëŒ€ê¸° ì½”íŠ¸ 2</span>
                        <button class="end-game-btn" onclick="resetCourt(1, 'waiting')">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="court-players"></div>
                </div>
                <div class="court waiting-court" data-court-type="waiting" data-court-index="2" draggable="true" ondragstart="handleCourtDragStart(event)" ondragend="handleCourtDragEnd(event)" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <div class="court-title">
                        <span class="court-number">ëŒ€ê¸° ì½”íŠ¸ 3</span>
                        <button class="end-game-btn" onclick="resetCourt(2, 'waiting')">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="court-players"></div>
                </div>
                <div class="court waiting-court" data-court-type="waiting" data-court-index="3" draggable="true" ondragstart="handleCourtDragStart(event)" ondragend="handleCourtDragEnd(event)" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <div class="court-title">
                        <span class="court-number">ëŒ€ê¸° ì½”íŠ¸ 4</span>
                        <button class="end-game-btn" onclick="resetCourt(3, 'waiting')">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="court-players"></div>
                </div>
            </div>
        </div>

        <!-- ëŒ€ê¸°ì˜ì—­ -->
        <div class="waiting-area">
            <!-- ì¶œì„ì ì˜ì—­ -->
            <div class="waiting-section present-area" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" data-area-type="present">
                <div class="waiting-area-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ëŒ€ê¸° ì„ ìˆ˜ <span id="present-count">(0)</span></span>
                    <button class="reset-present-btn" onclick="resetPresentArea()">ì „ì²´ ì´ˆê¸°í™”(ëŒ€ê¸°ì‚­ì œ)</button>
                </div>
                <div class="waiting-players" id="present-players"></div>
            </div>
            <!-- ë¯¸ì¶œì„ì ì˜ì—­ -->
            <div class="waiting-section absent-area" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" data-area-type="absent">
                <div class="waiting-area-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ì „ì²´ ì„ ìˆ˜ <span id="absent-count">(0)</span></span>
                    <div style="display: flex; gap: 5px;">
                        <button class="reset-present-btn" onclick="resetAbsentArea()">ê²Œì„ìˆ˜ ì´ˆê¸°í™”</button>
                        <button class="delete-all-btn" onclick="deleteAllAbsentPlayers()">ì „ì²´ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="waiting-players" id="absent-players"></div>
            </div>
        </div>

        <!-- ì„ ìˆ˜ ê´€ë¦¬ -->
        <div class="player-management">
            <div class="player-management-title">ì„ ìˆ˜ ê´€ë¦¬</div>
            <div class="add-player-form">
                <input type="text" class="add-player-input" id="player-name-input" placeholder="ì„ ìˆ˜ ì´ë¦„" onkeypress="handleKeyPress(event)">
                <select class="add-player-select" id="player-grade-input" required>
                    <option value="">ë“±ê¸‰ ì„ íƒ (í•„ìˆ˜)</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="ì´ˆì‹¬">ì´ˆì‹¬</option>
                </select>
                <select class="add-player-select" id="player-gender-input" required>
                    <option value="">ì„±ë³„ ì„ íƒ (í•„ìˆ˜)</option>
                    <option value="ë‚¨">ë‚¨</option>
                    <option value="ì—¬">ì—¬</option>
                </select>
                <button class="add-player-btn" onclick="addPlayer()">ì„ ìˆ˜ ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        // ë°ì´í„° êµ¬ì¡°
        let gameData = {
            players: [],
            gameCourts: [[], [], [], []],
            waitingCourts: [[], [], [], []],
            presentArea: [],  // ì¶œì„ì ì˜ì—­
            absentArea: [],   // ë¯¸ì¶œì„ì ì˜ì—­
            lessonCourts: [false, false, false, false],  // ë ˆìŠ¨ ì½”íŠ¸ ì—¬ë¶€
            gameHistory: []  // ê²Œì„ ì½”íŠ¸ ë°°ì • íˆìŠ¤í† ë¦¬ (ì„ ìˆ˜ ID ë°°ì—´ì˜ ë°°ì—´)
        };

        let nextPlayerId = 1;

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ
        function loadData() {
            const saved = localStorage.getItem('badmintonGameData');
            if (saved) {
                const parsed = JSON.parse(saved);
                gameData = parsed;
                
                // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±: waitingAreaê°€ ìˆìœ¼ë©´ presentAreaë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
                if (parsed.waitingArea && parsed.waitingArea.length > 0) {
                    if (!gameData.presentArea) {
                        gameData.presentArea = [];
                    }
                    parsed.waitingArea.forEach(playerId => {
                        if (!gameData.presentArea.includes(playerId)) {
                            gameData.presentArea.push(playerId);
                        }
                    });
                    delete gameData.waitingArea;
                }
                
                // presentAreaì™€ absentAreaê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                if (!gameData.presentArea) {
                    gameData.presentArea = [];
                }
                if (!gameData.absentArea) {
                    gameData.absentArea = [];
                }
                
                // lessonCourtsê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                if (!gameData.lessonCourts) {
                    gameData.lessonCourts = [false, false, false, false];
                }
                
                // gameHistoryê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                if (!gameData.gameHistory) {
                    gameData.gameHistory = [];
                }
                
                // ê¸°ì¡´ ì„ ìˆ˜ ë°ì´í„°ì— grade í•„ë“œê°€ ì—†ìœ¼ë©´ ì¶”ê°€ (í˜¸í™˜ì„±)
                gameData.players.forEach(player => {
                    if (!player.hasOwnProperty('grade')) {
                        player.grade = '';
                    }
                    // ê¸°ì¡´ ì„ ìˆ˜ ë°ì´í„°ì— gameCount í•„ë“œê°€ ì—†ìœ¼ë©´ ì¶”ê°€ (í˜¸í™˜ì„±)
                    if (!player.hasOwnProperty('gameCount')) {
                        player.gameCount = 0;
                    }
                    // ê¸°ì¡´ ì„ ìˆ˜ ë°ì´í„°ì— gender í•„ë“œê°€ ì—†ìœ¼ë©´ ì¶”ê°€ (í˜¸í™˜ì„±)
                    if (!player.hasOwnProperty('gender')) {
                        player.gender = 'ë‚¨'; // ê¸°ë³¸ê°’ ë‚¨ì„±
                    }
                });
                
                // nextPlayerId ê³„ì‚°
                if (gameData.players.length > 0) {
                    nextPlayerId = Math.max(...gameData.players.map(p => p.id)) + 1;
                }
                
                // ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì €ì¥
                saveData();
            }
            render();
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë°ì´í„° ì €ì¥
        function saveData() {
            localStorage.setItem('badmintonGameData', JSON.stringify(gameData));
        }

        // ì„ ìˆ˜ ì¶”ê°€
        function addPlayer() {
            const nameInput = document.getElementById('player-name-input');
            const gradeInput = document.getElementById('player-grade-input');
            const genderInput = document.getElementById('player-gender-input');
            const name = nameInput.value.trim();
            const grade = gradeInput.value;
            const gender = genderInput.value;
            
            if (name === '') {
                alert('ì„ ìˆ˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (grade === '') {
                alert('ë“±ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”.');
                gradeInput.focus();
                return;
            }

            if (gender === '') {
                alert('ì„±ë³„ì„ ì„ íƒí•˜ì„¸ìš”.');
                genderInput.focus();
                return;
            }

            // ì´ë¦„ ì¤‘ë³µ ì²´í¬
            const isDuplicate = gameData.players.some(player => player.name.trim() === name);
            if (isDuplicate) {
                alert('ì´ë¯¸ ë“±ë¡ëœ ì„ ìˆ˜ ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
                nameInput.focus();
                return;
            }

            const player = {
                id: nextPlayerId++,
                name: name,
                grade: grade,
                gender: gender,
                gameCount: 0
            };

            gameData.players.push(player);
            gameData.absentArea.push(player.id);  // ê¸°ë³¸ì ìœ¼ë¡œ ë¯¸ì¶œì„ì ì˜ì—­ì— ì¶”ê°€
            nameInput.value = '';
            gradeInput.value = '';
            genderInput.value = '';
            saveData();
            render();
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (Enter í‚¤)
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                addPlayer();
            }
        }

        // ì„ ìˆ˜ ì‚­ì œ ë˜ëŠ” ë¯¸ì¶œì„ìë¡œ ì´ë™
        function deletePlayer(playerId) {
            const isInPresentArea = gameData.presentArea.includes(playerId);
            const isInAbsentArea = gameData.absentArea.includes(playerId);
            
            // ì¶œì„ìì¸ ê²½ìš° ë¯¸ì¶œì„ìë¡œ ì´ë™
            if (isInPresentArea) {
                // ì½”íŠ¸ì— ìˆëŠ” ê²½ìš°ë„ ì²˜ë¦¬
                removePlayerFromAllCourts(playerId);
                gameData.presentArea = gameData.presentArea.filter(id => id !== playerId);
                if (!gameData.absentArea.includes(playerId)) {
                    gameData.absentArea.push(playerId);
                }
                saveData();
                render();
                return;
            }
            
            // ë¯¸ì¶œì„ìì¸ ê²½ìš°ì—ë§Œ ì‹¤ì œ ì‚­ì œ
            if (!isInAbsentArea) {
                alert('ëŒ€ê¸°ì˜ì—­ì˜ ì„ ìˆ˜ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ì •ë§ ì´ ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            // ëª¨ë“  ìœ„ì¹˜ì—ì„œ ì„ ìˆ˜ ì œê±°
            gameData.presentArea = gameData.presentArea.filter(id => id !== playerId);
            gameData.absentArea = gameData.absentArea.filter(id => id !== playerId);
            gameData.gameCourts.forEach(court => {
                const index = court.indexOf(playerId);
                if (index > -1) court.splice(index, 1);
            });
            gameData.waitingCourts.forEach(court => {
                const index = court.indexOf(playerId);
                if (index > -1) court.splice(index, 1);
            });
            gameData.players = gameData.players.filter(p => p.id !== playerId);
            
            saveData();
            render();
        }

        // ì¶œì„ ëŒ€ê¸° ì˜ì—­ ì´ˆê¸°í™” (ë¯¸ì¶œì„ìœ¼ë¡œ ì´ë™)
        function resetPresentArea() {
            if (gameData.presentArea.length === 0) {
                alert('ì´ˆê¸°í™”í•  ì¶œì„ ëŒ€ê¸° ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const count = gameData.presentArea.length;
            if (!confirm(`ì¶œì„ ëŒ€ê¸° ${count}ëª…ì„ ëª¨ë‘ ë¯¸ì¶œì„ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            // ì¶œì„ ëŒ€ê¸° ì˜ì—­ì˜ ëª¨ë“  ì„ ìˆ˜ ID ì €ì¥
            const presentPlayerIds = [...gameData.presentArea];

            // ì¶œì„ ëŒ€ê¸° ì˜ì—­ì—ì„œ ì œê±°í•˜ê³  ë¯¸ì¶œì„ ì˜ì—­ìœ¼ë¡œ ì´ë™
            presentPlayerIds.forEach(playerId => {
                // ì¶œì„ ëŒ€ê¸° ì˜ì—­ì—ì„œ ì œê±°
                gameData.presentArea = gameData.presentArea.filter(id => id !== playerId);
                // ë¯¸ì¶œì„ ì˜ì—­ì— ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
                if (!gameData.absentArea.includes(playerId)) {
                    gameData.absentArea.push(playerId);
                }
            });
            
            saveData();
            render();
        }

        // ë¯¸ì¶œì„ì ì „ì²´ ì´ˆê¸°í™” (ê²Œì„ ìˆ˜ 0ìœ¼ë¡œ ì„¤ì •)
        function resetAbsentArea() {
            if (gameData.absentArea.length === 0) {
                alert('ê²Œì„ìˆ˜ ì´ˆê¸°í™”í•  ë¯¸ì¶œì„ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const count = gameData.absentArea.length;
            if (!confirm(`ë¯¸ì¶œì„ì ${count}ëª…ì˜ ê²Œì„ ìˆ˜ë¥¼ ëª¨ë‘ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            // ë¯¸ì¶œì„ì ì˜ì—­ì˜ ëª¨ë“  ì„ ìˆ˜ì˜ ê²Œì„ ìˆ˜ë¥¼ 0ìœ¼ë¡œ ì„¤ì •
            gameData.absentArea.forEach(playerId => {
                const player = gameData.players.find(p => p.id === playerId);
                if (player) {
                    player.gameCount = 0;
                }
            });
            
            saveData();
            render();
        }

        // ë¯¸ì¶œì„ì ì „ì²´ ì‚­ì œ
        function deleteAllAbsentPlayers() {
            if (gameData.absentArea.length === 0) {
                alert('ì‚­ì œí•  ë¯¸ì¶œì„ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const count = gameData.absentArea.length;
            if (!confirm(`ì •ë§ ë¯¸ì¶œì„ì ${count}ëª…ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            // ë¯¸ì¶œì„ì ì˜ì—­ì˜ ëª¨ë“  ì„ ìˆ˜ ID ì €ì¥
            const absentPlayerIds = [...gameData.absentArea];

            // ëª¨ë“  ìœ„ì¹˜ì—ì„œ ì„ ìˆ˜ ì œê±°
            absentPlayerIds.forEach(playerId => {
                gameData.presentArea = gameData.presentArea.filter(id => id !== playerId);
                gameData.absentArea = gameData.absentArea.filter(id => id !== playerId);
                gameData.gameCourts.forEach(court => {
                    const index = court.indexOf(playerId);
                    if (index > -1) court.splice(index, 1);
                });
                gameData.waitingCourts.forEach(court => {
                    const index = court.indexOf(playerId);
                    if (index > -1) court.splice(index, 1);
                });
            });

            // ì„ ìˆ˜ ëª©ë¡ì—ì„œë„ ì œê±°
            gameData.players = gameData.players.filter(p => !absentPlayerIds.includes(p.id));
            
            saveData();
            render();
        }

        // ì½”íŠ¸ ë“œë˜ê·¸ ì‹œì‘ (ëŒ€ê¸° ì½”íŠ¸ ì „ì²´)
        function handleCourtDragStart(event) {
            // ì½”íŠ¸ ìì²´ë¥¼ ë“œë˜ê·¸í•˜ëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
            if (!event.target.classList.contains('waiting-court')) {
                return;
            }
            
            event.stopPropagation();
            event.dataTransfer.effectAllowed = 'move';
            const courtIndex = parseInt(event.target.dataset.courtIndex);
            event.dataTransfer.setData('courtDrag', 'true');
            event.dataTransfer.setData('sourceCourtType', 'waiting');
            event.dataTransfer.setData('sourceCourtIndex', courtIndex.toString());
            event.target.classList.add('dragging');
        }

        // ì½”íŠ¸ ë“œë˜ê·¸ ì¢…ë£Œ
        function handleCourtDragEnd(event) {
            if (event.target.classList.contains('waiting-court')) {
                event.target.classList.remove('dragging');
                // ëª¨ë“  ë“œë¡­ ì¡´ì—ì„œ drag-over í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.court').forEach(court => {
                    court.classList.remove('drag-over');
                });
            }
        }

        // ì„ ìˆ˜ ë“œë˜ê·¸ ì‹œì‘
        function handleDragStart(event) {
            // ì½”íŠ¸ ë“œë˜ê·¸ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ì²˜ë¦¬
            if (event.target.closest('.waiting-court') && event.target.closest('.waiting-court') === event.target) {
                return;
            }
            
            event.dataTransfer.effectAllowed = 'move';
            const playerId = event.target.dataset.playerId;
            if (!playerId) return;
            
            event.dataTransfer.setData('text/plain', playerId);
            event.dataTransfer.setData('courtDrag', 'false');
            
            // ë“œë˜ê·¸ ì‹œì‘í•œ ì„ ìˆ˜ê°€ ì–´ëŠ ì½”íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸
            let sourceCourtType = null;
            let sourceCourtIndex = null;
            
            // ê²Œì„ì¤‘ ì½”íŠ¸ í™•ì¸
            for (let i = 0; i < gameData.gameCourts.length; i++) {
                if (gameData.gameCourts[i].includes(parseInt(playerId))) {
                    sourceCourtType = 'game';
                    sourceCourtIndex = i;
                    break;
                }
            }
            
            // ëŒ€ê¸°ì¤‘ ì½”íŠ¸ í™•ì¸
            if (!sourceCourtType) {
                for (let i = 0; i < gameData.waitingCourts.length; i++) {
                    if (gameData.waitingCourts[i].includes(parseInt(playerId))) {
                        sourceCourtType = 'waiting';
                        sourceCourtIndex = i;
                        break;
                    }
                }
            }
            
            // ì†ŒìŠ¤ ì •ë³´ ì €ì¥
            event.dataTransfer.setData('sourceCourtType', sourceCourtType || '');
            event.dataTransfer.setData('sourceCourtIndex', sourceCourtIndex !== null ? sourceCourtIndex.toString() : '');
            
            event.target.classList.add('dragging');
        }

        // ë“œë˜ê·¸ ì¢…ë£Œ
        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            // ëª¨ë“  ë“œë¡­ ì¡´ì—ì„œ drag-over í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.court').forEach(court => {
                court.classList.remove('drag-over');
            });
            document.querySelector('.waiting-area').classList.remove('drag-over');
        }

        // ë“œë˜ê·¸ ì˜¤ë²„
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const dropZone = event.currentTarget.closest('.court') || event.currentTarget;
            dropZone.classList.add('drag-over');
        }

        // ë“œë˜ê·¸ ë¦¬ë¸Œ
        function handleDragLeave(event) {
            const dropZone = event.currentTarget.closest('.court') || event.currentTarget;
            // ìì‹ ìš”ì†Œë¡œ ì´ë™í•˜ëŠ” ê²½ìš°ëŠ” ì œì™¸
            if (!dropZone.contains(event.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        }

        // ë“œë¡­ ì²˜ë¦¬
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            const dropZone = event.currentTarget.closest('.court') || event.currentTarget;
            dropZone.classList.remove('drag-over');

            // ì½”íŠ¸ ì „ì²´ ë“œë˜ê·¸ì¸ì§€ í™•ì¸
            const isCourtDrag = event.dataTransfer.getData('courtDrag') === 'true';
            
            if (isCourtDrag) {
                // ì½”íŠ¸ ì „ì²´ ë“œë˜ê·¸ ì²˜ë¦¬
                const sourceCourtType = event.dataTransfer.getData('sourceCourtType');
                const sourceCourtIndex = parseInt(event.dataTransfer.getData('sourceCourtIndex'));
                
                if (dropZone.classList.contains('court')) {
                    const courtElement = dropZone.closest('.court');
                    const targetCourtType = courtElement.dataset.courtType;
                    const targetCourtIndex = parseInt(courtElement.dataset.courtIndex);
                    
                    // ëŒ€ê¸° ì½”íŠ¸ì—ì„œ ê²Œì„ì¤‘ ì½”íŠ¸ë¡œ ë“œë˜ê·¸í•˜ëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
                    if (sourceCourtType === 'waiting' && targetCourtType === 'game') {
                        const sourceCourt = gameData.waitingCourts[sourceCourtIndex];
                        const targetCourt = gameData.gameCourts[targetCourtIndex];
                        
                        // ëŒ€ê¸° ì½”íŠ¸ì— ì„ ìˆ˜ê°€ ì—†ìœ¼ë©´ ë³€í™” ì—†ìŒ
                        if (sourceCourt.length === 0) {
                            return;
                        }
                        
                        // ëŒ€ê¸° ì½”íŠ¸ì˜ ëª¨ë“  ì„ ìˆ˜ë¥¼ ê²Œì„ì¤‘ ì½”íŠ¸ë¡œ ì´ë™
                        const playersToMove = [...sourceCourt];
                        
                        // ìš©ëŸ‰ í™•ì¸ (ëŒ€ê¸° ì½”íŠ¸ì˜ ì„ ìˆ˜ë§Œ ì²´í¬, ê¸°ì¡´ ì„ ìˆ˜ëŠ” ì¶œì„ ëŒ€ê¸°ë¡œ ì´ë™í•˜ë¯€ë¡œ)
                        if (playersToMove.length > 4) {
                            alert('ì½”íŠ¸ëŠ” ìµœëŒ€ 4ëª…ê¹Œì§€ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                        
                        // ê²Œì„ì¤‘ ì½”íŠ¸ì˜ ê¸°ì¡´ ì„ ìˆ˜ë“¤ì„ ì¶œì„ ëŒ€ê¸°ë¡œ ì´ë™ (ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬)
                        const existingPlayers = [...targetCourt];
                        existingPlayers.forEach(existingPlayerId => {
                            // ê²Œì„ ì¢…ë£Œ: ê²Œì„ ìˆ˜ ì¦ê°€ (ë ˆìŠ¨ ì½”íŠ¸ ì œì™¸)
                            if (!gameData.lessonCourts || !gameData.lessonCourts[targetCourtIndex]) {
                                const player = gameData.players.find(p => p.id === existingPlayerId);
                                if (player) {
                                    if (!player.gameCount) {
                                        player.gameCount = 0;
                                    }
                                    player.gameCount++;
                                }
                            }
                            
                            // ì¶œì„ì ì˜ì—­ì—ì„œ ì œê±° (ì¤‘ë³µ ë°©ì§€)
                            gameData.presentArea = gameData.presentArea.filter(id => id !== existingPlayerId);
                            gameData.absentArea = gameData.absentArea.filter(id => id !== existingPlayerId);
                            // ì¶œì„ ëŒ€ê¸° ì˜ì—­ì— ì¶”ê°€
                            if (!gameData.presentArea.includes(existingPlayerId)) {
                                gameData.presentArea.push(existingPlayerId);
                            }
                        });
                        
                        // ê²Œì„ì¤‘ ì½”íŠ¸ ë¹„ìš°ê¸°
                        targetCourt.length = 0;
                        
                        // ëŒ€ê¸° ì½”íŠ¸ì˜ ì„ ìˆ˜ë“¤ì„ ê²Œì„ì¤‘ ì½”íŠ¸ë¡œ ì´ë™
                        playersToMove.forEach(movePlayerId => {
                            // ì¶œì„ì ì˜ì—­ì—ì„œ ì œê±° (ì½”íŠ¸ì— ë°°ì •ë˜ë¯€ë¡œ)
                            gameData.presentArea = gameData.presentArea.filter(id => id !== movePlayerId);
                            gameData.absentArea = gameData.absentArea.filter(id => id !== movePlayerId);
                            // ê²Œì„ì¤‘ ì½”íŠ¸ì— ì¶”ê°€
                            if (!targetCourt.includes(movePlayerId)) {
                                targetCourt.push(movePlayerId);
                            }
                        });
                        
                        // ëŒ€ê¸° ì½”íŠ¸ ë¹„ìš°ê¸°
                        sourceCourt.length = 0;
                        
                        // ê²Œì„ ì½”íŠ¸ íˆìŠ¤í† ë¦¬ ì €ì¥ (ë ˆìŠ¨ ì½”íŠ¸ ì œì™¸)
                        saveGameHistory(targetCourt, targetCourtIndex);
                        
                        saveData();
                        render();
                        return;
                    }
                }
                return;
            }

            // ì„ ìˆ˜ ê°œë³„ ë“œë˜ê·¸ ì²˜ë¦¬
            const playerId = parseInt(event.dataTransfer.getData('text/plain'));
            if (!playerId) return;
            
            // ë“œë¡­ ì¡´ì´ ì½”íŠ¸ì¸ì§€ í™•ì¸
            if (dropZone.classList.contains('court')) {
                const courtElement = dropZone.closest('.court');
                const targetCourtType = courtElement.dataset.courtType;
                const targetCourtIndex = parseInt(courtElement.dataset.courtIndex);
                
                // ì†ŒìŠ¤ ì½”íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const sourceCourtType = event.dataTransfer.getData('sourceCourtType');
                const sourceCourtIndex = event.dataTransfer.getData('sourceCourtIndex') !== '' 
                    ? parseInt(event.dataTransfer.getData('sourceCourtIndex')) 
                    : null;
                
                const targetCourt = targetCourtType === 'game' 
                    ? gameData.gameCourts[targetCourtIndex] 
                    : gameData.waitingCourts[targetCourtIndex];
                
                // ê°œë³„ ì„ ìˆ˜ ë“œë˜ê·¸ëŠ” ì¼ë°˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ìœ¼ë¡œ ì²˜ë¦¬
                // (ëŒ€ê¸° ì½”íŠ¸ì˜ ëª¨ë“  ì„ ìˆ˜ë¥¼ ì´ë™ì‹œí‚¤ì§€ ì•Šê³ , ë“œë˜ê·¸í•œ ì„ ìˆ˜ë§Œ ì´ë™)
                
                // ëŒ€ê¸° ì½”íŠ¸ì—ì„œ ê²Œì„ ì½”íŠ¸ë¡œ ì´ë™ ì²˜ë¦¬
                if (sourceCourtType === 'waiting' && targetCourtType === 'game' && sourceCourtIndex !== null) {
                    const sourceCourt = gameData.waitingCourts[sourceCourtIndex];
                    
                    // ìš©ëŸ‰ í™•ì¸ (ìµœëŒ€ 4ëª…)
                    if (targetCourt.length >= 4) {
                        alert('ì½”íŠ¸ëŠ” ìµœëŒ€ 4ëª…ê¹Œì§€ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ì´ë¯¸ í•´ë‹¹ ì½”íŠ¸ì— ìˆëŠ” ê²½ìš° ë¬´ì‹œ
                    if (targetCourt.includes(playerId)) {
                        return;
                    }
                    
                    // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
                    const index = sourceCourt.indexOf(playerId);
                    if (index > -1) {
                        sourceCourt.splice(index, 1);
                    }
                    
                    // ê²Œì„ ì½”íŠ¸ì— ì¶”ê°€
                    targetCourt.push(playerId);
                    
                    // ê²Œì„ ì½”íŠ¸ íˆìŠ¤í† ë¦¬ ì €ì¥ (ë ˆìŠ¨ ì½”íŠ¸ ì œì™¸)
                    saveGameHistory(targetCourt, targetCourtIndex);
                    
                    saveData();
                    render();
                    return;
                }
                
                // ê²Œì„ ì½”íŠ¸ ê°„ ì´ë™ ì²˜ë¦¬ (ê²Œì„ ì½”íŠ¸ ë‚´ì—ì„œ ì„ ìˆ˜ ì´ë™ ê°€ëŠ¥)
                if (sourceCourtType === 'game' && targetCourtType === 'game' && sourceCourtIndex !== null) {
                    const sourceCourt = gameData.gameCourts[sourceCourtIndex];
                    
                    // ê°™ì€ ê²Œì„ ì½”íŠ¸ ë‚´ ì´ë™ì¸ ê²½ìš° ìˆœì„œë§Œ ë³€ê²½
                    if (sourceCourtIndex === targetCourtIndex) {
                        // ì´ë¯¸ ê°™ì€ ì½”íŠ¸ì— ìˆìœ¼ë¯€ë¡œ ìˆœì„œ ë³€ê²½ë§Œ í—ˆìš©
                        // ì‹¤ì œë¡œëŠ” removePlayerFromAllCourtsê°€ í˜¸ì¶œë˜ë¯€ë¡œ ì¬ë°°ì¹˜ë¨
                    } else {
                        // ë‹¤ë¥¸ ê²Œì„ ì½”íŠ¸ë¡œ ì´ë™
                        if (targetCourt.length >= 4) {
                            alert('ì½”íŠ¸ëŠ” ìµœëŒ€ 4ëª…ê¹Œì§€ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                    }
                    
                    // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
                    const index = sourceCourt.indexOf(playerId);
                    if (index > -1) {
                        sourceCourt.splice(index, 1);
                    }
                    
                    // ìƒˆ ìœ„ì¹˜ì— ì¶”ê°€
                    if (!targetCourt.includes(playerId)) {
                        targetCourt.push(playerId);
                    }
                    
                    // ê²Œì„ ì½”íŠ¸ íˆìŠ¤í† ë¦¬ ì €ì¥ (ë ˆìŠ¨ ì½”íŠ¸ ì œì™¸)
                    saveGameHistory(targetCourt, targetCourtIndex);
                    
                    saveData();
                    render();
                    return;
                }
                
                // ê²Œì„ ì½”íŠ¸ì—ì„œ ëŒ€ê¸° ì½”íŠ¸ë¡œ ì´ë™ ì²˜ë¦¬
                if (sourceCourtType === 'game' && targetCourtType === 'waiting' && sourceCourtIndex !== null) {
                    const sourceCourt = gameData.gameCourts[sourceCourtIndex];
                    
                    // ìš©ëŸ‰ í™•ì¸ (ìµœëŒ€ 4ëª…)
                    if (targetCourt.length >= 4) {
                        alert('ì½”íŠ¸ëŠ” ìµœëŒ€ 4ëª…ê¹Œì§€ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ì´ë¯¸ í•´ë‹¹ ì½”íŠ¸ì— ìˆëŠ” ê²½ìš° ë¬´ì‹œ
                    if (targetCourt.includes(playerId)) {
                        return;
                    }
                    
                    // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
                    const index = sourceCourt.indexOf(playerId);
                    if (index > -1) {
                        sourceCourt.splice(index, 1);
                    }
                    
                    // ëŒ€ê¸° ì½”íŠ¸ì— ì¶”ê°€
                    targetCourt.push(playerId);
                    
                    saveData();
                    render();
                    return;
                }
                
                // ëŒ€ê¸° ì½”íŠ¸ ê°„ ì´ë™ ì²˜ë¦¬ (ëŒ€ê¸° ì½”íŠ¸ ë‚´ì—ì„œ ì„ ìˆ˜ ì´ë™ ê°€ëŠ¥)
                if (sourceCourtType === 'waiting' && targetCourtType === 'waiting' && sourceCourtIndex !== null) {
                    const sourceCourt = gameData.waitingCourts[sourceCourtIndex];
                    
                    // ê°™ì€ ëŒ€ê¸° ì½”íŠ¸ ë‚´ ì´ë™ì¸ ê²½ìš° ìˆœì„œë§Œ ë³€ê²½
                    if (sourceCourtIndex === targetCourtIndex) {
                        // ì´ë¯¸ ê°™ì€ ì½”íŠ¸ì— ìˆìœ¼ë¯€ë¡œ ìˆœì„œ ë³€ê²½ë§Œ í—ˆìš©
                        // ì‹¤ì œë¡œëŠ” removePlayerFromAllCourtsê°€ í˜¸ì¶œë˜ë¯€ë¡œ ì¬ë°°ì¹˜ë¨
                    } else {
                        // ë‹¤ë¥¸ ëŒ€ê¸° ì½”íŠ¸ë¡œ ì´ë™
                        if (targetCourt.length >= 4) {
                            alert('ì½”íŠ¸ëŠ” ìµœëŒ€ 4ëª…ê¹Œì§€ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                    }
                    
                    // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
                    const index = sourceCourt.indexOf(playerId);
                    if (index > -1) {
                        sourceCourt.splice(index, 1);
                    }
                    
                    // ìƒˆ ìœ„ì¹˜ì— ì¶”ê°€
                    if (!targetCourt.includes(playerId)) {
                        targetCourt.push(playerId);
                    }
                    
                    saveData();
                    render();
                    return;
                }
                
                // ì¼ë°˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ (ê¸°ì¡´)
                // ì¶œì„ìë§Œ ì½”íŠ¸ë¡œ ë°°ì • ê°€ëŠ¥
                if (!gameData.presentArea.includes(playerId)) {
                    const courtTypeName = targetCourtType === 'game' ? 'ê²Œì„ ì½”íŠ¸' : 'ëŒ€ê¸° ì½”íŠ¸';
                    alert(`ì¶œì„ìë§Œ ${courtTypeName}ì— ë°°ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    return;
                }

                // ìš©ëŸ‰ í™•ì¸ (ìµœëŒ€ 4ëª…)
                if (targetCourt.length >= 4) {
                    alert('ì½”íŠ¸ëŠ” ìµœëŒ€ 4ëª…ê¹Œì§€ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì´ë¯¸ í•´ë‹¹ ì½”íŠ¸ì— ìˆëŠ” ê²½ìš° ë¬´ì‹œ (ë‹¤ë¥¸ ì½”íŠ¸ì—ì„œ ì˜¨ ê²½ìš°ë§Œ ì²˜ë¦¬)
                if (targetCourt.includes(playerId)) {
                    return;
                }

                // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
                removePlayerFromAllCourts(playerId);
                gameData.presentArea = gameData.presentArea.filter(id => id !== playerId);
                gameData.absentArea = gameData.absentArea.filter(id => id !== playerId);

                // ìƒˆ ìœ„ì¹˜ì— ì¶”ê°€
                targetCourt.push(playerId);
                
                // ê²Œì„ ì½”íŠ¸ íˆìŠ¤í† ë¦¬ ì €ì¥ (ë ˆìŠ¨ ì½”íŠ¸ ì œì™¸)
                if (targetCourtType === 'game') {
                    saveGameHistory(targetCourt, targetCourtIndex);
                }
            } else if (dropZone.classList.contains('waiting-section')) {
                // ëŒ€ê¸°ì˜ì—­ìœ¼ë¡œ ì´ë™
                const areaType = dropZone.dataset.areaType;
                
                // ì¶œì„ ëŒ€ê¸° ì˜ì—­ ë‚´ì—ì„œ ìˆœì„œ ë³€ê²½
                if (areaType === 'present' && gameData.presentArea.includes(playerId)) {
                    // ì¶œì„ ëŒ€ê¸° ì˜ì—­ ë‚´ì—ì„œ ë“œë˜ê·¸í•œ ê²½ìš° ìˆœì„œë§Œ ë³€ê²½
                    const sourceIndex = gameData.presentArea.indexOf(playerId);
                    gameData.presentArea.splice(sourceIndex, 1);
                    
                    // ë“œë¡­ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ì„ ìˆ˜ ìš”ì†Œ ì°¾ê¸°
                    const presentContainer = document.getElementById('present-players');
                    const dropX = event.clientX;
                    const dropY = event.clientY;
                    
                    // ë“œë¡­ ìœ„ì¹˜ì˜ ìš”ì†Œ ì°¾ê¸°
                    const elementBelow = document.elementFromPoint(dropX, dropY);
                    let targetPlayerElement = null;
                    
                    // ë“œë¡­ ìœ„ì¹˜ì—ì„œ ì„ ìˆ˜ ìš”ì†Œ ì°¾ê¸° (ë¶€ëª¨ ìš”ì†Œê¹Œì§€ í™•ì¸)
                    if (elementBelow) {
                        targetPlayerElement = elementBelow.closest('.player');
                        if (!targetPlayerElement || !presentContainer.contains(targetPlayerElement)) {
                            // ë“œë¡­ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ì„ ìˆ˜ ìš”ì†Œ ì°¾ê¸°
                            const children = Array.from(presentContainer.children);
                            let minDistance = Infinity;
                            for (const child of children) {
                                const rect = child.getBoundingClientRect();
                                const centerY = rect.top + rect.height / 2;
                                const distance = Math.abs(dropY - centerY);
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    targetPlayerElement = child;
                                }
                            }
                        }
                    }
                    
                    // íƒ€ê²Ÿ ì„ ìˆ˜ì˜ ë°”ë¡œ ì•ì— ì‚½ì…
                    if (targetPlayerElement && targetPlayerElement.dataset.playerId) {
                        const targetPlayerId = parseInt(targetPlayerElement.dataset.playerId);
                        const targetIndex = gameData.presentArea.indexOf(targetPlayerId);
                        if (targetIndex !== -1) {
                            gameData.presentArea.splice(targetIndex, 0, playerId);
                        } else {
                            gameData.presentArea.push(playerId);
                        }
                    } else {
                        // íƒ€ê²Ÿì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ë§¨ ì•ì— ì¶”ê°€
                        gameData.presentArea.unshift(playerId);
                    }
                } else {
                    // ë‹¤ë¥¸ ì˜ì—­ì—ì„œ ì¶œì„ ëŒ€ê¸° ì˜ì—­ìœ¼ë¡œ ì´ë™
                    removePlayerFromAllCourts(playerId);
                    gameData.presentArea = gameData.presentArea.filter(id => id !== playerId);
                    gameData.absentArea = gameData.absentArea.filter(id => id !== playerId);
                    
                    if (areaType === 'present') {
                        gameData.presentArea.push(playerId);
                    } else {
                        gameData.absentArea.push(playerId);
                    }
                }
            }

            saveData();
            render();
        }

        // ëª¨ë“  ì½”íŠ¸ì—ì„œ ì„ ìˆ˜ ì œê±°
        function removePlayerFromAllCourts(playerId) {
            gameData.gameCourts.forEach(court => {
                const index = court.indexOf(playerId);
                if (index > -1) court.splice(index, 1);
            });
            gameData.waitingCourts.forEach(court => {
                const index = court.indexOf(playerId);
                if (index > -1) court.splice(index, 1);
            });
        }

        // ê²Œì„ ì¢…ë£Œ
        function endGame(courtIndex, courtType) {
            const targetCourt = courtType === 'game' 
                ? gameData.gameCourts[courtIndex] 
                : gameData.waitingCourts[courtIndex];

            if (targetCourt.length === 0) {
                alert('ë°°ì •ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê²Œì„ ì½”íŠ¸ì¸ ê²½ìš° ì„ ìˆ˜ë“¤ì˜ ê²Œì„ ìˆ˜ ì¦ê°€ (ë ˆìŠ¨ ì½”íŠ¸ ì œì™¸)
            if (courtType === 'game' && (!gameData.lessonCourts || !gameData.lessonCourts[courtIndex])) {
                targetCourt.forEach(playerId => {
                    const player = gameData.players.find(p => p.id === playerId);
                    if (player) {
                        if (!player.gameCount) {
                            player.gameCount = 0;
                        }
                        player.gameCount++;
                    }
                });
            }

            // ëª¨ë“  ì„ ìˆ˜ë¥¼ ì¶œì„ì ì˜ì—­ìœ¼ë¡œ ì´ë™
            targetCourt.forEach(playerId => {
                if (!gameData.presentArea.includes(playerId)) {
                    gameData.presentArea.push(playerId);
                }
            });

            // ì½”íŠ¸ ë¹„ìš°ê¸°
            targetCourt.length = 0;

            saveData();
            render();
        }

        // ì½”íŠ¸ ì´ˆê¸°í™” (ëŒ€ê¸°ì¤‘ ì½”íŠ¸ìš©)
        function resetCourt(courtIndex, courtType) {
            const targetCourt = courtType === 'waiting' 
                ? gameData.waitingCourts[courtIndex] 
                : gameData.gameCourts[courtIndex];

            if (targetCourt.length === 0) {
                alert('ë°°ì •ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ëª¨ë“  ì„ ìˆ˜ë¥¼ ì¶œì„ì ì˜ì—­ìœ¼ë¡œ ì´ë™
            targetCourt.forEach(playerId => {
                if (!gameData.presentArea.includes(playerId)) {
                    gameData.presentArea.push(playerId);
                }
            });

            // ì½”íŠ¸ ë¹„ìš°ê¸°
            targetCourt.length = 0;

            saveData();
            render();
        }

        // ë ˆìŠ¨ ì½”íŠ¸ í† ê¸€
        function toggleLessonCourt(courtIndex) {
            if (!gameData.lessonCourts) {
                gameData.lessonCourts = [false, false, false, false];
            }
            gameData.lessonCourts[courtIndex] = !gameData.lessonCourts[courtIndex];
            saveData();
            render();
        }

        // ê²Œì„ ì½”íŠ¸ ë°°ì • íˆìŠ¤í† ë¦¬ ì €ì¥
        function saveGameHistory(court, courtIndex) {
            // ë ˆìŠ¨ ì½”íŠ¸ëŠ” íˆìŠ¤í† ë¦¬ì— ì €ì¥í•˜ì§€ ì•ŠìŒ
            if (courtIndex !== null && gameData.lessonCourts && gameData.lessonCourts[courtIndex]) {
                return;
            }
            
            if (court.length === 4) {
                // ì„ ìˆ˜ ID ë°°ì—´ì„ ì •ë ¬í•´ì„œ ì €ì¥ (ìˆœì„œ ë¬´ê´€í•˜ê²Œ ë¹„êµí•˜ê¸° ìœ„í•´)
                const sortedPlayerIds = [...court].sort((a, b) => a - b);
                
                // ì¤‘ë³µ ì²´í¬ (ê°™ì€ ì¸ì›ì´ ì´ë¯¸ íˆìŠ¤í† ë¦¬ì— ìˆìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ)
                const isDuplicate = gameData.gameHistory.some(history => {
                    const sortedHistory = [...history].sort((a, b) => a - b);
                    return JSON.stringify(sortedHistory) === JSON.stringify(sortedPlayerIds);
                });
                
                if (!isDuplicate) {
                    gameData.gameHistory.push([...court]);
                    saveData();
                }
            }
        }

        // ëŒ€ê¸° ì½”íŠ¸ì— ê°™ì€ ì¸ì›ì´ ê²Œì„ ì½”íŠ¸ì— ë°°ì •ëœ ì ì´ ìˆëŠ”ì§€ í™•ì¸
        function checkGameHistory(court) {
            if (court.length !== 4) {
                return null;
            }

            // ì„ ìˆ˜ ID ë°°ì—´ì„ ì •ë ¬í•´ì„œ ë¹„êµ
            const sortedPlayerIds = [...court].sort((a, b) => a - b);
            
            // íˆìŠ¤í† ë¦¬ì—ì„œ ê°™ì€ ì¸ì› ì°¾ê¸°
            const hasHistory = gameData.gameHistory.some(history => {
                const sortedHistory = [...history].sort((a, b) => a - b);
                return JSON.stringify(sortedHistory) === JSON.stringify(sortedPlayerIds);
            });

            if (hasHistory) {
                // ì„ ìˆ˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                const playerNames = court.map(playerId => {
                    const player = gameData.players.find(p => p.id === playerId);
                    return player ? player.name : '';
                }).filter(name => name !== '');
                
                return `â„¹ï¸ ì´ì „ì— ê²Œì„ ì½”íŠ¸ì— ë°°ì •ëœ ì ì´ ìˆëŠ” ì¡°í•©ì…ë‹ˆë‹¤.`;
            }

            return null;
        }

        // ë“±ê¸‰ ì²´í¬ í•¨ìˆ˜ (ëŒ€ê¸° ì½”íŠ¸ì— 4ëª… ë°°ì • ì‹œ ì ì ˆì„± í™•ì¸)
        function checkGradeBalance(court) {
            if (court.length !== 4) {
                return null; // 4ëª…ì´ ì•„ë‹ˆë©´ ì²´í¬í•˜ì§€ ì•ŠìŒ
            }

            // ë“±ê¸‰ ìˆœì„œ ì •ì˜ (ìˆ«ìê°€ í´ìˆ˜ë¡ ë†’ì€ ë“±ê¸‰)
            const gradeOrder = {
                'A': 5,
                'B': 4,
                'C': 3,
                'D': 2,
                'ì´ˆì‹¬': 1
            };

            // ì„ ìˆ˜ë“¤ì˜ ë“±ê¸‰ ê°€ì ¸ì˜¤ê¸°
            const playerGrades = court.map(playerId => {
                const player = gameData.players.find(p => p.id === playerId);
                if (!player || !player.grade) return null;
                return {
                    id: playerId,
                    name: player.name,
                    grade: player.grade,
                    gradeValue: gradeOrder[player.grade] || 0
                };
            }).filter(p => p !== null && p.gradeValue > 0);

            if (playerGrades.length !== 4) {
                return null; // ë“±ê¸‰ì´ ì—†ëŠ” ì„ ìˆ˜ê°€ ìˆìœ¼ë©´ ì²´í¬í•˜ì§€ ì•ŠìŒ
            }

            // ë“±ê¸‰ ê°’ìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ë“±ê¸‰ë¶€í„°)
            const sortedGrades = [...playerGrades].sort((a, b) => b.gradeValue - a.gradeValue);

            // ë£° 1: ì œì¼ ë†’ì€ ë“±ê¸‰ê³¼ ì œì¼ ë‚®ì€ ë“±ê¸‰ì´ í•œ íŒ€
            const team1GradeSum = sortedGrades[0].gradeValue + sortedGrades[3].gradeValue;
            
            // ë£° 2: ë‚˜ë¨¸ì§€ 2ëª…ì´ í•œ íŒ€
            const team2GradeSum = sortedGrades[1].gradeValue + sortedGrades[2].gradeValue;

            // ë£° 3: íŒ€ê°„ ë“±ê¸‰ í•©ì˜ ì°¨ì´ê°€ 2ë ˆë²¨ ì´ìƒì´ë©´ ë¶€ì ì ˆ
            const gradeDiff = Math.abs(team1GradeSum - team2GradeSum);

            if (gradeDiff >= 2) {
                // ë“±ê¸‰ ì´ë¦„ìœ¼ë¡œ ë³€í™˜
                const team1Grades = [sortedGrades[0].grade, sortedGrades[3].grade].sort((a, b) => gradeOrder[b] - gradeOrder[a]);
                const team2Grades = [sortedGrades[1].grade, sortedGrades[2].grade].sort((a, b) => gradeOrder[b] - gradeOrder[a]);
                
                return `âš ï¸ ë“±ê¸‰ ë¶ˆê· í˜•: íŒ€1(${team1Grades.join(', ')})ê³¼ íŒ€2(${team2Grades.join(', ')})ì˜ ë“±ê¸‰ ì°¨ì´ê°€ í½ë‹ˆë‹¤.`;
            }

            return null; // ì ì ˆí•œ ë°°ì •
        }

        // ì„ ìˆ˜ ìš”ì†Œ ìƒì„±
        function createPlayerElement(player, showDelete = false) {
            const div = document.createElement('div');
            div.className = 'player';
            
            // ì„±ë³„ì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€
            const gender = player.gender || 'ë‚¨';
            if (gender === 'ì—¬') {
                div.classList.add('female');
            } else {
                div.classList.add('male');
            }
            
            div.dataset.playerId = player.id;
            div.draggable = true;
            
            // ì´ë¦„, ë“±ê¸‰, ê²Œì„ ìˆ˜ í‘œì‹œ
            let displayText = player.name;
            if (player.grade) {
                displayText += ` (${player.grade})`;
            }
            const gameCount = player.gameCount || 0;
            if (gameCount > 0) {
                displayText += ` [${gameCount}ê²Œì„]`;
            }
            div.textContent = displayText;
            
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);

            if (showDelete) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deletePlayer(player.id);
                };
                div.appendChild(deleteBtn);
            }

            return div;
        }

        // ë Œë”ë§
        function render() {
            // ì„ ìˆ˜ ìˆ˜ ì—…ë°ì´íŠ¸
            const presentCountElement = document.getElementById('present-count');
            const absentCountElement = document.getElementById('absent-count');
            if (presentCountElement) {
                presentCountElement.textContent = `(${gameData.presentArea.length})`;
            }
            if (absentCountElement) {
                absentCountElement.textContent = `(${gameData.absentArea.length})`;
            }

            // ì¶œì„ì ì˜ì—­ ë Œë”ë§
            const presentPlayersContainer = document.getElementById('present-players');
            presentPlayersContainer.innerHTML = '';
            
            gameData.presentArea.forEach(playerId => {
                const player = gameData.players.find(p => p.id === playerId);
                if (player) {
                    const playerElement = createPlayerElement(player, true);
                    presentPlayersContainer.appendChild(playerElement);
                }
            });

            // ë¯¸ì¶œì„ì ì˜ì—­ ë Œë”ë§ (ì´ë¦„ ìˆœìœ¼ë¡œ ì •ë ¬)
            const absentPlayersContainer = document.getElementById('absent-players');
            absentPlayersContainer.innerHTML = '';
            
            // ë¯¸ì¶œì„ì ì„ ìˆ˜ë“¤ì„ ì´ë¦„ ìˆœìœ¼ë¡œ ì •ë ¬
            const absentPlayers = gameData.absentArea
                .map(playerId => gameData.players.find(p => p.id === playerId))
                .filter(player => player !== undefined)
                .sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            
            absentPlayers.forEach(player => {
                const playerElement = createPlayerElement(player, true);
                absentPlayersContainer.appendChild(playerElement);
            });

            // ê²Œì„ì¤‘ ì½”íŠ¸ ë Œë”ë§
            gameData.gameCourts.forEach((court, index) => {
                const courtElement = document.querySelector(`.court.game-court[data-court-index="${index}"] .court-players`);
                courtElement.innerHTML = '';
                
                if (court.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'empty-court-message';
                    emptyMsg.textContent = 'ì„ ìˆ˜ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ë°°ì •í•˜ì„¸ìš”';
                    courtElement.appendChild(emptyMsg);
                } else {
                    court.forEach(playerId => {
                        const player = gameData.players.find(p => p.id === playerId);
                        if (player) {
                            const playerElement = createPlayerElement(player);
                            courtElement.appendChild(playerElement);
                        }
                    });
                }
            });

            // ëŒ€ê¸°ì¤‘ ì½”íŠ¸ ë Œë”ë§
            gameData.waitingCourts.forEach((court, index) => {
                const courtElement = document.querySelector(`.court.waiting-court[data-court-index="${index}"] .court-players`);
                courtElement.innerHTML = '';
                
                if (court.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'empty-court-message';
                    emptyMsg.textContent = 'ì„ ìˆ˜ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ë°°ì •í•˜ì„¸ìš”';
                    courtElement.appendChild(emptyMsg);
                } else {
                    court.forEach(playerId => {
                        const player = gameData.players.find(p => p.id === playerId);
                        if (player) {
                            const playerElement = createPlayerElement(player);
                            courtElement.appendChild(playerElement);
                        }
                    });
                    
                    // 4ëª…ì´ ë°°ì •ë˜ì—ˆì„ ë•Œ ë“±ê¸‰ ì²´í¬ ë° íˆìŠ¤í† ë¦¬ ì²´í¬
                    if (court.length === 4) {
                        const warningMessage = checkGradeBalance(court);
                        if (warningMessage) {
                            const warningDiv = document.createElement('div');
                            warningDiv.className = 'court-warning-message';
                            warningDiv.textContent = warningMessage;
                            courtElement.appendChild(warningDiv);
                        }
                        
                        // ê²Œì„ ì½”íŠ¸ íˆìŠ¤í† ë¦¬ ì²´í¬
                        const historyMessage = checkGameHistory(court);
                        if (historyMessage) {
                            const historyDiv = document.createElement('div');
                            historyDiv.className = 'court-warning-message';
                            historyDiv.style.background = '#e3f2fd';
                            historyDiv.style.color = '#1976d2';
                            historyDiv.textContent = historyMessage;
                            courtElement.appendChild(historyDiv);
                        }
                    }
                }
            });

            // ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë° ë ˆìŠ¨ ì½”íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.end-game-btn').forEach(btn => {
                const courtElement = btn.closest('.court');
                const courtType = courtElement.dataset.courtType;
                const courtIndex = parseInt(courtElement.dataset.courtIndex);
                const targetCourt = courtType === 'game' 
                    ? gameData.gameCourts[courtIndex] 
                    : gameData.waitingCourts[courtIndex];
                
                btn.disabled = targetCourt.length === 0;
            });

            // ë ˆìŠ¨ ì½”íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (gameData.lessonCourts) {
                gameData.lessonCourts.forEach((isLesson, index) => {
                    const courtElement = document.querySelector(`.court.game-court[data-court-index="${index}"]`);
                    const lessonBtn = courtElement.querySelector('.lesson-btn');
                    
                    if (isLesson) {
                        courtElement.classList.add('lesson-court');
                        lessonBtn.classList.add('active');
                        lessonBtn.textContent = 'ë ˆìŠ¨ âœ“';
                    } else {
                        courtElement.classList.remove('lesson-court');
                        lessonBtn.classList.remove('active');
                        lessonBtn.textContent = 'ë ˆìŠ¨';
                    }
                });
            }
        }

        // ë“œë˜ê·¸ ë¦¬ë¸Œ ì´ë²¤íŠ¸ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.court, .waiting-section').forEach(element => {
                element.addEventListener('dragleave', handleDragLeave);
            });
        });

        // ì´ˆê¸°í™”
        loadData();
    </script>
</body>
</html>
